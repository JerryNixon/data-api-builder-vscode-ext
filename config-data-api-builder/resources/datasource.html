<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit DAB Data Source</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .header button {
      padding: 10px 20px;
      background-color: #0078d4;
      color: white;
      border: none;
      cursor: pointer;
    }

    .header button:hover {
      background-color: #005a9e;
    }

    .scroll-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
    }

    form {
      max-width: 600px;
      margin: 0 auto;
    }

    .section {
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .section-header {
      font-weight: bold;
      font-size: large;
      cursor: pointer;
      background-color: #f0f0f0;
      padding: 10px;
      display: flex;
      align-items: center;
    }

    .section-header::before {
      content: '⯈';
      margin-right: 8px;
      transition: transform 0.2s ease;
    }

    .section.open .section-header::before {
      content: '⯆';
    }

    .section-content {
      padding: 10px 15px;
      display: none;
    }

    .section.open .section-content {
      display: block;
    }

    /* ** */

    .reset-button {
      background: none;
      border: none;
      cursor: pointer;
      color: #555;
      display: inline;
      width: 30px;
      vertical-align: text-bottom;
    }

    .reset-button:hover {
      color: #0078d4;
    }

    /* ** */

    div.check-input {
      margin-top: 10px;
      margin-bottom: 10px;
      margin-left: 0px;
    }

    label.check-input {
      font-weight: normal;
    }

    input.check-input {
      width: auto;
      padding: 4px;
      margin-top: 5px;
      box-sizing: border-box;
    }

    /* ** */

    div.text-input-label {
      margin-top: 10px;
    }

    label.text-input-label {
      display: inline;
      margin-top: 15px;
      font-weight: normal;
    }

    div.text-input {
      margin-left: 35px;
      margin-bottom: 10px;
    }

    input.text-input {
      width: 100%;
      padding: 4px;
      margin-top: 5px;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <div class="header">
    <button type="button" id="saveButton">Save</button>
  </div>

  <div class="scroll-container">
    <form id="configForm">

      <h1>Data Source</h1>

      <div class="text-input-label">
        <button style="visibility: collapse;" type="button" class="reset-button"></button>
        <label class="text-input-label" for="databaseType">Database Type</label>
      </div>
      <div class="text-input">
        <input class="text-input" type="text" id="databaseType" placeholder="/api" readonly>
      </div>

      <div class="text-input-label">
        <button style="visibility: collapse;" type="button" class="reset-button"></button>
        <label class="text-input-label" for="connectionString">Connection String</label>
      </div>
      <div class="text-input">
        <input class="text-input" type="text" id="connectionString" placeholder="/api">
      </div>

      <div class="check-input">
        <button type="button" class="reset-button" title="Reset to Default"
          onclick="resetField('setSessionContext', false)">⚙️</button>
        <label class="check-input"><input class="check-input" type="checkbox" id="setSessionContext">Set Session
          Context</label>
      </div>

      <h1>Runtime</h1>

      <div class="section open">
        <div class="section-header">REST Configuration</div>
        <div class="section-content">

          <div class="check-input">
            <button type="button" class="reset-button" onclick="resetField('restEnabled', true)"
              title="Reset to Default">⚙️</button>
            <label class="check-input" for="restEnabled"><input type="checkbox" id="restEnabled" class="check-input">
              REST Enabled</label>
          </div>

          <div class="text-input-label">
            <button type="button" class="reset-button" onclick="resetField('restPath', '/api')"
              title="Reset to Default">⚙️</button>
            <label class="text-input-label" for="restPath">REST Path</label>
          </div>
          <div class="text-input">
            <input class="text-input" type="text" id="restPath" placeholder="/api">
          </div>

          <div class="check-input">
            <button type="button" class="reset-button" onclick="resetField('requestBodyStrict', false)"
              title="Reset to Default">⚙️</button>
            <input class="check-input" type="checkbox" id="requestBodyStrict">
            <label class="check-input" for="requestBodyStrict">Request Body Strict</label>
          </div>

        </div>
      </div>

      <div class="section open">
        <div class="section-header">GraphQL Configuration</div>
        <div class="section-content">

          <div class="check-input">
            <button type="button" class="reset-button" onclick="resetField('graphqlEnabled', true)"
              title="Reset to Default">⚙️</button>
            <label class="check-input" for="graphqlEnabled">
              <input class="check-input" type="checkbox" id="graphqlEnabled"> GraphQL Enabled
            </label>
          </div>

          <div class="text-input-label">
            <button type="button" class="reset-button" onclick="resetField('graphqlPath', '/graphql')"
              title="Reset to Default">⚙️</button>
            <label class="text-input" for="graphqlPath">GraphQL Path</label>
          </div>
          <div class="text-input">
            <input class="text-input" type="text" id="graphqlPath" placeholder="/graphql">
          </div>

          <div class="check-input">
            <button type="button" class="reset-button" onclick="resetField('allowIntrospection', false)"
              title="Reset to Default">⚙️</button>
            <label class="check-input" for="allowIntrospection">
              <input class="check-input" type="checkbox" id="allowIntrospection"> Allow Introspection
            </label>
          </div>

        </div>
      </div>

      <div class="section open">
        <div class="section-header">Host Configuration</div>
        <div class="section-content">

          <span class="radio-label">Host Mode</span>
          <div class="radio-group">
            <div class="form-group">
              <button type="button" class="reset-button" onclick="resetField('hostModeDevelopment', true)"
                title="Reset to default value: Development">⚙️</button>
              <label class="radio-group">
                <input type="radio" name="hostMode" value="development" id="hostModeDevelopment"> Development
              </label>
            </div>

            <div class="form-group">
              <button type="button" class="reset-button" onclick="resetField('hostModeProduction', false)"
                title="Reset to default value: Production">⚙️</button>
              <label class="radio-group">
                <input type="radio" name="hostMode" value="production" id="hostModeProduction"> Production
              </label>
            </div>
          </div>

          <label class="form-group" for="corsOrigins">CORS Origins</label>
          <div class="input-group">
            <button type="button" class="reset-button"
              onclick="resetField('corsOrigins', 'https://example1.com, https://example2.com')"
              title="Reset to default value: https://example1.com, https://example2.com">⚙️</button>
            <input type="text" id="corsOrigins"
              placeholder="Enter origins, e.g., https://example1.com, https://example2.com">
          </div>

          <div class="form-group">
            <button type="button" class="checkbox reset-button" onclick="resetField('corsAllowCredentials', false)"
              title="Reset to default value: False">⚙️</button>
            <label class="checkbox" for="corsAllowCredentials">
              <input type="checkbox" id="corsAllowCredentials"> Allow Credentials
            </label>
          </div>

        </div>
      </div>

      <div class="section open">
        <div class="section-header">Authentication Configuration</div>
        <div class="section-content">
          <div>
            <span class="radio-group">Authentication Provider</span>
            <div class="radio-group">
              <label class="radio-group"><input type="radio" name="authProvider" value="StaticWebApps"
                  id="authProviderStaticWebApps">
                StaticWebApps</label>
              <label class="radio-group"><input type="radio" name="authProvider" value="AppService"
                  id="authProviderAppService">
                AppService</label>
              <label class="radio-group"><input type="radio" name="authProvider" value="AzureAd"
                  id="authProviderAzureAd"> AzureAd</label>
              <label class="radio-group"><input type="radio" name="authProvider" value="Simulator"
                  id="authProviderSimulator">
                Simulator</label>
            </div>
          </div>

          <label for="jwtAudience">JWT Audience</label>
          <input type="text" id="jwtAudience" placeholder="Enter JWT audience">

          <label for="jwtIssuer">JWT Issuer</label>
          <input type="text" id="jwtIssuer" placeholder="Enter JWT issuer">
        </div>
      </div>

      <div class="section">
        <div class="section-header">Pagination Configuration</div>
        <div class="section-content">
          <label for="maxPageSize">Max Page Size</label>
          <input type="number" id="maxPageSize" placeholder="100000">

          <label for="defaultPageSize">Default Page Size</label>
          <input type="number" id="defaultPageSize" placeholder="100">
        </div>
      </div>

      <div class="section">
        <div class="section-header">Cache Configuration</div>
        <div class="section-content">
          <label><input type="checkbox" id="cacheEnabled"> Enable Cache</label>

          <label for="cacheTtlSeconds">Cache TTL (seconds)</label>
          <input type="number" id="cacheTtlSeconds" placeholder="5">
        </div>
      </div>

      <div class="section">
        <div class="section-header">Telemetry Configuration</div>
        <div class="section-content">
          <label for="appInsightsConnectionString">Application Insights Connection String</label>
          <input type="text" id="appInsightsConnectionString" placeholder="Enter connection string">

          <label><input type="checkbox" id="appInsightsEnabled"> Enable Application Insights</label>

          <label for="otelEndpoint">Open Telemetry Endpoint</label>
          <input type="text" id="otelEndpoint" placeholder="Enter OpenTelemetry endpoint">

          <label for="otelHeaders">Open Telemetry Headers</label>
          <input type="text" id="otelHeaders" placeholder="Enter headers">

          <label for="otelServiceName">Open Telemetry Service Name</label>
          <input type="text" id="otelServiceName" placeholder="dab">

          <div>
            <span class="radio-group">Open Telemetry Exporter Protocol</span>
            <div class="radio-group">
              <label class="radio-group"><input type="radio" name="otelExporterProtocol" value="grpc"
                  id="otelExporterGrpc"> gRPC</label>
              <label class="radio-group"><input type="radio" name="otelExporterProtocol" value="httpprotobuf"
                  id="otelExporterHttpProtobuf">
                HTTP Protobuf</label>
            </div>
          </div>

          <label><input type="checkbox" id="otelEnabled"> Enable Open Telemetry</label>
        </div>
      </div>

    </form>
  </div>

  <script>
    const vscode = acquireVsCodeApi();

    let currentConfig = {};

    function loadDatasource(config) {
      currentConfig = config;

      const setValue = (id, value, defaultValue = '') => {
        const element = document.getElementById(id);
        if (element) {
          if (typeof value === 'object' && value !== null) {
            element.value = JSON.stringify(value);
          } else {
            element.value = value ?? defaultValue;
          }
        } else {
          console.error(`Element with id '${id}' not found`);
        }
      };

      const setChecked = (id, value) => {
        const element = document.getElementById(id);
        if (element) {
          console.log(`Setting ${id} to`, value);
          element.checked = Boolean(value);
        } else {
          console.error(`Element with id '${id}' not found`);
        }
      };

      const setRadioValue = (name, value, defaultValue) => {
        const radios = document.getElementsByName(name);
        const selectedValue = value ?? defaultValue;
        radios.forEach(radio => {
          radio.checked = radio.value === selectedValue;
        });
      };

      console.log('loadDatasource called with:', config);

      // Populate Data Source fields
      const dataSource = config['data-source'] || {};
      console.log('dataSource:', dataSource);
      setValue('databaseType', dataSource['database-type'], 'mssql');
      setValue('connectionString', dataSource['connection-string']);
      setChecked('setSessionContext', dataSource.options?.['set-session-context']);

      const runtime = config.runtime || {};

      // Populate Host Configuration fields
      const host = runtime.host || {};
      setRadioValue('hostMode', host.mode, 'development');
      setValue('corsOrigins', (host.cors?.origins || []).join(', '));
      setChecked('corsAllowCredentials', host.cors?.['allow-credentials']);
      setRadioValue('authProvider', host.authentication?.provider, 'StaticWebApps');
      setValue('jwtAudience', host.authentication?.jwt?.audience);
      setValue('jwtIssuer', host.authentication?.jwt?.issuer);

      // Populate REST Configuration fields
      const rest = runtime.rest || {};
      setChecked('restEnabled', rest.enabled);
      setValue('restPath', rest.path, '/api');
      setChecked('requestBodyStrict', rest['request-body-strict']);

      // Populate GraphQL Configuration fields
      const graphql = runtime.graphql || {};
      setChecked('graphqlEnabled', graphql.enabled);
      setValue('graphqlPath', graphql.path, '/graphql');
      setChecked('allowIntrospection', graphql['allow-introspection']);

      // Populate Pagination Configuration fields
      const pagination = runtime.pagination || {};
      setValue('maxPageSize', pagination['max-page-size'], 100000);
      setValue('defaultPageSize', pagination['default-page-size'], 100);

      // Populate Cache Configuration fields
      const cache = runtime.cache || {};
      setChecked('cacheEnabled', cache.enabled);
      setValue('cacheTtlSeconds', cache['ttl-seconds'], 5);

      // Populate Telemetry Configuration fields
      const telemetry = runtime.telemetry || {};
      const appInsights = telemetry['application-insights'] || {};
      setValue('appInsightsConnectionString', appInsights['connection-string']);
      setChecked('appInsightsEnabled', appInsights.enabled);

      const openTelemetry = telemetry['open-telemetry'] || {};
      setValue('otelEndpoint', openTelemetry.endpoint);
      setValue('otelHeaders', openTelemetry.headers);
      setValue('otelServiceName', openTelemetry['service-name'], 'dab');
      setRadioValue('otelExporterProtocol', openTelemetry['exporter-protocol'], 'grpc');
      setChecked('otelEnabled', openTelemetry.enabled);
    }

    function saveDatasource() {
      const getValueString = (id, defaultValue = '') => {
        const element = document.getElementById(id);
        return element ? element.value || defaultValue : defaultValue;
      };

      const getValueInt = (id, defaultValue = 0) => {
        const element = document.getElementById(id);
        return element ? parseInt(element.value, 10) || defaultValue : defaultValue;
      };

      const getChecked = (id) => {
        const element = document.getElementById(id);
        return element ? element.checked : false;
      };

      const getRadioValue = (name, defaultValue = '') => {
        const checkedRadio = document.querySelector(`input[name="${name}"]:checked`);
        return checkedRadio ? checkedRadio.value : defaultValue;
      };

      console.log('Saving dataSource with currentConfig:', currentConfig);

      // Construct the dataSource object
      currentConfig['data-source'] = {
        'database-type': getValueString('databaseType'),
        'connection-string': getValueString('connectionString'),
        options: {
          'set-session-context': getChecked('setSessionContext')
        }
      };

      currentConfig.runtime = currentConfig.runtime || {};
      currentConfig.runtime.host = {
        mode: getRadioValue('hostMode', 'development'),
        cors: {
          origins: getValueString('corsOrigins')
            .split(',')
            .map(origin => origin.trim())
            .filter(origin => origin),
          'allow-credentials': getChecked('corsAllowCredentials')
        },
        authentication: {
          provider: getRadioValue('authProvider', 'StaticWebApps'),
          jwt: {
            audience: getValueString('jwtAudience'),
            issuer: getValueString('jwtIssuer')
          }
        }
      };

      currentConfig.runtime.rest = {
        enabled: getChecked('restEnabled'),
        path: getValueString('restPath', '/api'),
        'request-body-strict': getChecked('requestBodyStrict')
      };

      currentConfig.runtime.graphql = {
        enabled: getChecked('graphqlEnabled'),
        path: getValueString('graphqlPath', '/graphql'),
        'allow-introspection': getChecked('allowIntrospection')
      };

      currentConfig.runtime.pagination = {
        'max-page-size': getValueInt('maxPageSize', 100000),
        'default-page-size': getValueInt('defaultPageSize', 100)
      };

      currentConfig.runtime.cache = {
        enabled: getChecked('cacheEnabled'),
        'ttl-seconds': getValueInt('cacheTtlSeconds', 5)
      };

      currentConfig.runtime.telemetry = {
        'application-insights': {
          'connection-string': getValueString('appInsightsConnectionString'),
          enabled: getChecked('appInsightsEnabled')
        },
        'open-telemetry': {
          endpoint: getValueString('otelEndpoint'),
          headers: getValueString('otelHeaders'),
          'service-name': getValueString('otelServiceName', 'dab'),
          'exporter-protocol': getRadioValue('otelExporterProtocol', 'grpc'),
          enabled: getChecked('otelEnabled')
        }
      };

      console.log('Updated currentConfig:', currentConfig);
      vscode.postMessage({ command: 'save', content: JSON.stringify(currentConfig) });
    }

    window.addEventListener('message', (event) => {
      console.log('Received event:', event);
      console.log('Received event.data:', event.data);

      if (event.data.command === 'load') {
        console.log('Received config:', event.data.config);
        loadDatasource(event.data.config || {});
      }
    });

    document.querySelectorAll('.section-header').forEach((header) => {
      header.addEventListener('click', () => {
        const section = header.closest('.section');
        section.classList.toggle('open');
      });
    });

    function resetField(id, defaultValue) {
      const element = document.getElementById(id);
      if (!element) {
        console.error(`Element with id '${id}' not found`);
        return;
      }

      if (element.type === 'checkbox') {
        element.checked = Boolean(defaultValue);
      } else if (element.type === 'radio') {
        const radios = document.getElementsByName(element.name);
        radios.forEach(radio => {
          radio.checked = radio.value === defaultValue;
        });
      } else if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
        element.value = defaultValue;
      } else {
        console.error(`Unsupported element type for id '${id}'`);
      }
    }

    document.getElementById('saveButton').addEventListener('click', saveDatasource);

  </script>
</body>

</html>